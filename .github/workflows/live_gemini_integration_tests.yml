name: Live Gemini Integration Tests

on:
  # Manual trigger with optional inputs
  workflow_dispatch:
    inputs:
      batch_size:
        description: 'Number of traces to test'
        required: false
        default: '5'
      verbose:
        description: 'Enable verbose logging'
        required: false
        default: 'false'
        type: boolean

  # Run on schedule (weekly on Sunday at 3am UTC)
  schedule:
    - cron: '0 3 * * 0'

  # Run on PRs that modify extraction code
  pull_request:
    paths:
      - 'src/extraction/**'
      - 'tests/integration/test_extraction_live_gemini.py'
      - '.github/workflows/live_gemini_integration_tests.yml'

# Prevent concurrent runs
concurrency:
  group: live-gemini-${{ github.ref }}
  cancel-in-progress: true

jobs:
  live-gemini-tests:
    name: Run Live Gemini Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    # Only run if secrets are available (skip for forks)
    if: ${{ github.event_name == 'workflow_dispatch' || github.event_name == 'schedule' || github.event.pull_request.head.repo.full_name == github.repository }}

    permissions:
      contents: read
      id-token: write  # Required for Workload Identity Federation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Run Live Gemini Integration Tests
        env:
          RUN_LIVE_TESTS: '1'
          GOOGLE_CLOUD_PROJECT: ${{ secrets.GCP_PROJECT_ID }}
          VERTEX_AI_LOCATION: 'us-central1'
          GEMINI_MODEL: 'gemini-2.5-flash'
          GEMINI_TEMPERATURE: '0.2'
          GEMINI_MAX_OUTPUT_TOKENS: '4096'
          PYTHONPATH: 'src'
        run: |
          echo "ðŸ§ª Running live Gemini integration tests..."
          pytest tests/integration/test_extraction_live_gemini.py -v \
            --tb=short \
            --junit-xml=test-results/live-gemini-results.xml

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: live-gemini-test-results
          path: test-results/
          retention-days: 30

      - name: Post Test Summary
        if: always()
        run: |
          echo "## Live Gemini Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -f test-results/live-gemini-results.xml ]; then
            echo "âœ… Test results uploaded as artifact" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ No test results file found" >> $GITHUB_STEP_SUMMARY
          fi

  # Notify on failure (only for scheduled runs)
  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: live-gemini-tests
    if: ${{ failure() && github.event_name == 'schedule' }}

    steps:
      - name: Create Issue on Failure
        uses: actions/github-script@v7
        with:
          script: |
            const title = `Live Gemini Integration Tests Failed - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## Scheduled Live Gemini Integration Tests Failed

            **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            **Date:** ${new Date().toISOString()}

            Please investigate the test failures and fix any issues with:
            - Gemini API connectivity
            - Schema validation
            - Extraction quality

            cc @${context.actor}
            `;

            // Check for existing open issue
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'live-gemini-test-failure'
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['live-gemini-test-failure', 'automated']
              });
            }
