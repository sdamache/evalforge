name: Live Gemini Integration Tests

on:
  schedule:
    # Run daily at 2 AM UTC to verify Gemini integration
    - cron: '0 2 * * *'
  workflow_dispatch:  # Allow manual trigger
  pull_request:
    paths:
      - 'src/extraction/**'
      - 'tests/integration/test_extraction_live_gemini.py'
      - '.github/workflows/live_gemini_integration_tests.yml'

env:
  PYTHON_VERSION: '3.11'
  GOOGLE_CLOUD_PROJECT: konveyn2ai
  VERTEX_AI_LOCATION: us-central1

jobs:
  live-gemini-tests:
    name: Live Gemini Integration Tests
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GOOGLE_CLOUD_CREDENTIALS }}

      - name: Set up Google Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GOOGLE_CLOUD_PROJECT }}

      - name: Enable Vertex AI API
        run: |
          gcloud services enable aiplatform.googleapis.com --project=${{ env.GOOGLE_CLOUD_PROJECT }}

      - name: Run Live Gemini Integration Tests
        env:
          RUN_LIVE_TESTS: '1'
          GOOGLE_CLOUD_PROJECT: ${{ env.GOOGLE_CLOUD_PROJECT }}
          VERTEX_AI_LOCATION: ${{ env.VERTEX_AI_LOCATION }}
          GEMINI_MODEL: gemini-2.5-flash
          GEMINI_TEMPERATURE: '0.2'
          GEMINI_MAX_OUTPUT_TOKENS: '4096'
        run: |
          PYTHONPATH=src python -m pytest \
            tests/integration/test_extraction_live_gemini.py \
            -v \
            --tb=short \
            --maxfail=3 \
            --timeout=300

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gemini-integration-test-results
          path: |
            pytest-report.xml
            pytest-coverage.xml
          retention-days: 7

      - name: Notify on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ðŸš¨ Live Gemini Integration Tests Failed',
              body: `Live Gemini integration tests failed on ${context.ref}\n\nWorkflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              labels: ['bug', 'integration-test', 'gemini']
            })

  integration-test-summary:
    name: Integration Test Summary
    runs-on: ubuntu-latest
    needs: live-gemini-tests
    if: always()

    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        if: needs.live-gemini-tests.result != 'skipped'
        continue-on-error: true
        with:
          name: gemini-integration-test-results
          path: test-results

      - name: Display test summary
        run: |
          echo "## Live Gemini Integration Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Status**: ${{ needs.live-gemini-tests.result }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project**: ${{ env.GOOGLE_CLOUD_PROJECT }}" >> $GITHUB_STEP_SUMMARY
          echo "**Location**: ${{ env.VERTEX_AI_LOCATION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.live-gemini-tests.result }}" = "success" ]; then
            echo "âœ… All Gemini integration tests passed" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.live-gemini-tests.result }}" = "skipped" ]; then
            echo "â­ï¸ Live tests skipped (requires GOOGLE_CLOUD_CREDENTIALS secret)" >> $GITHUB_STEP_SUMMARY
            echo "- Configure secret in repository settings to enable live testing on PRs" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Gemini integration tests failed - check logs for details" >> $GITHUB_STEP_SUMMARY
            echo "- Review Vertex AI API quotas" >> $GITHUB_STEP_SUMMARY
            echo "- Check service account permissions" >> $GITHUB_STEP_SUMMARY
            echo "- Verify Gemini model availability" >> $GITHUB_STEP_SUMMARY
          fi
