# Data Model: Guardrail Suggestion Engine

**Feature**: 005-guardrail-generation
**Date**: 2025-12-30

## Entity Relationship Diagram

```
┌─────────────────────┐
│     Suggestion      │
│  (type="guardrail") │
├─────────────────────┤
│ suggestion_id       │
│ type: "guardrail"   │
│ status: pending/... │
│ source_traces[]     │─────┐
│ suggestion_content  │     │
│   └── guardrail ────┼─────┼──▶ GuardrailDraft (embedded)
│ approval_metadata?  │     │
│ created_at          │     │
│ updated_at          │     │
└─────────────────────┘     │
                            │
┌─────────────────────┐     │
│   FailurePattern    │◀────┘
├─────────────────────┤
│ pattern_id          │
│ failure_type        │
│ confidence          │
│ reproduction_context│
│ extracted_at        │
└─────────────────────┘

┌─────────────────────┐
│   GuardrailRun      │
├─────────────────────┤
│ run_id              │
│ triggered_by        │
│ started_at          │
│ finished_at         │
│ batch_size          │
│ generated_count     │
│ skipped_count       │
│ error_count         │
└─────────────────────┘

┌─────────────────────┐
│  GuardrailError     │
├─────────────────────┤
│ run_id              │
│ suggestion_id       │
│ error_type          │
│ error_message       │
│ recorded_at         │
└─────────────────────┘
```

---

## Core Entities

### GuardrailDraft (embedded on Suggestion)

The primary artifact generated by this feature. Stored at `suggestion_content.guardrail`.

```python
@dataclass
class GuardrailDraft:
    """Structured guardrail rule draft generated from failure pattern."""

    # Identification
    guardrail_id: str              # Format: "guard_{suggestion_id}"
    rule_name: str                 # Snake_case descriptive name, max 100 chars

    # Classification
    guardrail_type: GuardrailType  # Enum: validation_rule, rate_limit, etc.
    failure_type: str              # Source failure type from suggestion

    # Configuration (guardrail-type-specific)
    configuration: dict            # Type-specific config (see schemas below)

    # Justification & Context
    description: str               # What this guardrail prevents, max 500 chars
    justification: str             # Why this prevents recurrence, max 800 chars
    estimated_prevention_rate: float  # 0.0-1.0, confidence in prevention

    # Lineage (source tracing)
    source: GuardrailDraftSource

    # Metadata
    status: GuardrailDraftStatus   # "draft" | "needs_human_input"
    edit_source: EditSource        # "generated" | "human"
    generated_at: datetime
    updated_at: datetime
    generator_meta: GuardrailDraftGeneratorMeta
```

### GuardrailDraftSource (lineage)

```python
@dataclass
class GuardrailDraftSource:
    """Tracks where this guardrail came from."""

    suggestion_id: str             # Owner suggestion
    canonical_trace_id: str        # Primary trace used for generation
    canonical_pattern_id: str      # Primary pattern used for generation
    trace_ids: List[str]           # All contributing trace IDs
    pattern_ids: List[str]         # All contributing pattern IDs
```

### GuardrailDraftGeneratorMeta (auditability)

```python
@dataclass
class GuardrailDraftGeneratorMeta:
    """Tracks how this guardrail was generated."""

    model: str                     # e.g., "gemini-2.5-flash"
    temperature: float             # e.g., 0.2
    prompt_hash: str               # SHA256 of generation prompt
    response_sha256: str           # SHA256 of Gemini response
    run_id: str                    # Links to GuardrailRun
    failure_type_mapping_version: str  # Version of GUARDRAIL_MAPPING used
```

---

## Configuration Schemas by Guardrail Type

### rate_limit

```python
@dataclass
class RateLimitConfig:
    max_calls: int                 # 1-1000, default 10
    window_seconds: int            # 1-86400, default 60
    scope: str                     # "session" | "user" | "global"
    action: str                    # "block" | "warn" | "block_and_alert"
```

### content_filter

```python
@dataclass
class ContentFilterConfig:
    filter_type: str               # "input" | "output" | "both"
    threshold: float               # 0.0-1.0, default 0.7
    categories: List[str]          # ["toxic", "harmful", "profane"]
    action: str                    # "block" | "warn" | "flag"
```

### redaction_rule

```python
@dataclass
class RedactionRuleConfig:
    patterns: List[str]            # ["email", "phone", "ssn", "credit_card"]
    custom_regex: Optional[str]    # Additional regex pattern
    scope: str                     # "input" | "output" | "both"
    action: str                    # "redact" | "block" | "warn"
```

### validation_rule

```python
@dataclass
class ValidationRuleConfig:
    check_type: str                # "pre_response" | "post_response"
    condition: str                 # Human-readable check description
    validation_source: Optional[str]  # "knowledge_base" | "external_api" | "rules"
```

### scope_limit

```python
@dataclass
class ScopeLimitConfig:
    allowed_tools: List[str]       # Whitelist of allowed tools
    blocked_tools: List[str]       # Blacklist of blocked tools
    context_rules: Optional[str]   # When to apply limits
    action: str                    # "block" | "warn"
```

### freshness_check

```python
@dataclass
class FreshnessCheckConfig:
    max_age_hours: int             # 1-8760, default 24
    data_sources: List[str]        # Which data sources to check
    action: str                    # "block" | "warn" | "refresh_and_retry"
```

### input_sanitization

```python
@dataclass
class InputSanitizationConfig:
    patterns: List[str]            # Known injection patterns
    custom_patterns: Optional[List[str]]  # Additional patterns
    action: str                    # "block" | "sanitize" | "warn"
```

---

## Supporting Entities

### GuardrailRun (batch execution tracking)

```python
@dataclass
class GuardrailRun:
    """Records a batch generation run."""

    run_id: str                    # Format: "run_{timestamp}_{uuid}"
    started_at: datetime
    finished_at: Optional[datetime]
    triggered_by: TriggeredBy      # "scheduled" | "manual"

    # Counts
    batch_size: int
    picked_up_count: int
    generated_count: int
    skipped_count: int
    error_count: int

    # Performance
    processing_duration_ms: Optional[int]

    # Per-suggestion outcomes (optional, for detailed runs)
    suggestion_outcomes: List[GuardrailOutcome]
```

### GuardrailOutcome

```python
@dataclass
class GuardrailOutcome:
    """Per-suggestion result within a run."""

    suggestion_id: str
    status: str                    # "generated" | "skipped" | "error"
    error_reason: Optional[str]    # If status=error or skipped
    guardrail_type: Optional[str]  # If status=generated
```

### GuardrailError (error recording)

```python
@dataclass
class GuardrailError:
    """Records per-suggestion generation failures."""

    run_id: str
    suggestion_id: str
    error_type: GuardrailErrorType
    error_message: str
    recorded_at: datetime

    # For debugging
    model_response_sha256: Optional[str]
    model_response_excerpt: Optional[str]  # First 200 chars, sanitized
```

---

## Enums

```python
class GuardrailType(str, Enum):
    VALIDATION_RULE = "validation_rule"
    RATE_LIMIT = "rate_limit"
    CONTENT_FILTER = "content_filter"
    REDACTION_RULE = "redaction_rule"
    SCOPE_LIMIT = "scope_limit"
    FRESHNESS_CHECK = "freshness_check"
    INPUT_SANITIZATION = "input_sanitization"

class GuardrailDraftStatus(str, Enum):
    DRAFT = "draft"
    NEEDS_HUMAN_INPUT = "needs_human_input"

class EditSource(str, Enum):
    GENERATED = "generated"
    HUMAN = "human"

class TriggeredBy(str, Enum):
    SCHEDULED = "scheduled"
    MANUAL = "manual"

class GuardrailErrorType(str, Enum):
    INVALID_JSON = "invalid_json"
    SCHEMA_VALIDATION = "schema_validation"
    VERTEX_ERROR = "vertex_error"
    TIMEOUT = "timeout"
    UNKNOWN = "unknown"
```

---

## Firestore Collections

| Collection | Document Key | Purpose |
|------------|--------------|---------|
| `{prefix}suggestions` | `suggestion_id` | Read for generation; Update `suggestion_content.guardrail` |
| `{prefix}failure_patterns` | `pattern_id` | Read for reproduction context + confidence |
| `{prefix}guardrail_runs` | `run_id` | Write batch run summaries |
| `{prefix}guardrail_errors` | `{run_id}:{suggestion_id}` | Write per-suggestion errors |

---

## State Transitions

### GuardrailDraft Lifecycle

```
[No Draft] ──generate──▶ [Draft: generated]
                              │
                    human edits│
                              ▼
                         [Draft: human]
                              │
             regenerate w/o   │  regenerate w/
             forceOverwrite   │  forceOverwrite
                    │         │         │
                    ▼         │         ▼
               [BLOCKED]      │    [Draft: generated]
                              │         (updated_at changed)
                              │
                              ▼
                    Approval via Issue #8 API
                              │
                              ▼
                    Suggestion.status = "approved"
                    (GuardrailDraft unchanged)
```

### Overwrite Rules

| Existing edit_source | forceOverwrite | Result |
|---------------------|----------------|--------|
| None (no draft) | N/A | Generate new draft |
| "generated" | false | Overwrite allowed |
| "generated" | true | Overwrite allowed |
| "human" | false | SKIP (blocked) |
| "human" | true | Overwrite allowed |

---

## Validation Rules

1. **guardrail_id**: Must match pattern `guard_{suggestion_id}`
2. **rule_name**: 1-100 characters, snake_case
3. **guardrail_type**: Must be valid enum value
4. **configuration**: Must validate against type-specific schema
5. **description**: Max 500 characters, PII-free
6. **justification**: Max 800 characters, PII-free
7. **estimated_prevention_rate**: 0.0 ≤ value ≤ 1.0
8. **trace_ids**: Non-empty list
9. **pattern_ids**: Non-empty list

---

## Indexes Required

Existing (from Issue #3):
- Composite: `suggestions(type, status, created_at DESC)`

New (for guardrail service):
- Simple: `guardrail_runs(started_at DESC)` - for health check last run query
